<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Satellite FOV Tool - Fixed Version</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            overflow: hidden;
        }
        
        .header {
            background: #2a5298;
            padding: 15px 20px;
            border-bottom: 3px solid #00ff00;
        }
        
        .header h1 {
            margin: 0 0 5px 0;
            color: #00ff00;
            font-size: 22px;
        }
        
        .header p {
            margin: 0;
            font-size: 13px;
            color: #ccc;
        }
        
        .search-bar {
            background: #2a2a2a;
            padding: 12px 15px;
            display: flex;
            gap: 10px;
        }
        
        #addressInput {
            flex: 1;
            padding: 10px;
            background: #1a1a1a;
            color: white;
            border: 2px solid #444;
            border-radius: 5px;
            font-size: 14px;
        }
        
        #searchBtn {
            padding: 10px 25px;
            background: #00ff00;
            color: black;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
        }
        
        #searchBtn:hover {
            background: #00dd00;
        }
        
        .container {
            display: flex;
            height: calc(100vh - 116px);
        }
        
        #map {
            flex: 1;
            position: relative;
        }
        
        .controls {
            width: 450px;
            background: #2a2a2a;
            padding: 15px;
            overflow-y: auto;
            border-left: 2px solid #00ff00;
        }
        
        .section {
            margin-bottom: 18px;
            background: #1a1a1a;
            padding: 12px;
            border-radius: 5px;
            border: 1px solid #444;
        }
        
        .section h3 {
            color: #00ff00;
            margin: 0 0 10px 0;
            font-size: 15px;
            border-bottom: 1px solid #444;
            padding-bottom: 6px;
        }
        
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        
        .btn {
            padding: 10px;
            background: #2a2a2a;
            color: white;
            border: 2px solid #444;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .btn:hover {
            border-color: #00ff00;
        }
        
        .btn.active {
            background: #00ff00;
            color: black;
            border-color: #00ff00;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 13px;
        }
        
        .value {
            color: #00ff00;
            font-weight: bold;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: #444;
            border-radius: 3px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #00ff00;
            border-radius: 50%;
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: #00ff00;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }
        
        .info-box {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 12px;
        }
        
        .info-row:last-child {
            margin-bottom: 0;
        }
        
        .assessment {
            padding: 12px;
            border-radius: 5px;
            text-align: center;
            margin: 10px 0;
            border: 2px solid;
            font-size: 13px;
        }
        
        .good {
            background: rgba(0, 255, 0, 0.1);
            border-color: #00ff00;
            color: #00ff00;
        }
        
        .warning {
            background: rgba(255, 165, 0, 0.1);
            border-color: #ffa500;
            color: #ffa500;
        }
        
        .bad {
            background: rgba(255, 0, 0, 0.1);
            border-color: #ff4444;
            color: #ff4444;
        }
        
        .question-box {
            background: #1a1a1a;
            padding: 12px;
            border-radius: 5px;
            border: 2px solid #00ff00;
            margin-bottom: 15px;
        }
        
        .question-box h4 {
            margin: 0 0 10px 0;
            color: #00ff00;
            font-size: 14px;
        }
        
        .question-item {
            margin-bottom: 12px;
            font-size: 12px;
        }
        
        .question-item:last-child {
            margin-bottom: 0;
        }
        
        .question-item label {
            display: block;
            margin-bottom: 6px;
        }
        
        .radio-group {
            display: flex;
            gap: 12px;
        }
        
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .assess-btn {
            width: 100%;
            padding: 10px;
            background: #00ff00;
            color: black;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            font-size: 13px;
        }
        
        .assess-btn:hover {
            background: #00dd00;
        }
        
        .clear-btn {
            width: 100%;
            padding: 10px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            font-size: 13px;
        }
        
        .clear-btn:hover {
            background: #ff2222;
        }
        
        .note {
            font-size: 11px;
            color: #888;
            font-style: italic;
            margin-top: 10px;
            padding: 8px;
            background: #1a1a1a;
            border-radius: 4px;
        }
        
        .highlight-note {
            font-size: 11px;
            color: #ffa500;
            background: rgba(255, 165, 0, 0.1);
            border: 1px solid #ffa500;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        .controls::-webkit-scrollbar {
            width: 8px;
        }
        
        .controls::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        .controls::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }
        
        .controls::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üõ∞Ô∏è Satellite Site Screening Tool</h1>
        <p>B2B-B2C Beta Site Pre-Screening - Fast filtering for obvious approve/reject sites</p>
        <p style="font-size: 11px; color: #ffa500; margin-top: 5px;">‚ö†Ô∏è SCREENING TOOL ONLY - Marginal sites require on-site validation</p>
    </div>

    <div class="search-bar">
        <input type="text" id="addressInput" placeholder="Enter address (e.g., 3462 NE Marion Lane, Issaquah, WA)">
        <button id="searchBtn">üîç Search Location</button>
    </div>

    <div class="container">
        <div id="map"></div>
        
        <div class="controls">
            <div class="section">
                <h3>üõ†Ô∏è View Tools</h3>
                <div class="btn-group">
                    <button class="btn" id="toggleViewBtn">üëÅÔ∏è Street View</button>
                    <button class="btn" id="distanceCirclesBtn">üìç 30m Zone</button>
                </div>
                <div class="btn-group" style="margin-top: 8px;">
                    <button class="btn" id="measureBtn">üìè Measure</button>
                    <button class="btn" id="clearToolsBtn">üóëÔ∏è Clear Tools</button>
                </div>
                <div class="info-box">
                    <div style="font-size: 11px; color: #aaa;">
                        <strong>Cone Opacity:</strong> <span class="value" id="opacityValue">25%</span>
                    </div>
                    <input type="range" id="opacitySlider" min="0" max="80" value="25" style="margin-top: 5px;">
                </div>
            </div>

            <div class="section">
                <h3>‚ö° RF Beam Divergence (NEW!)</h3>
                <button class="btn" id="toggleBeamBtn" style="width: 100%; margin-bottom: 10px;">Show Beam Path</button>
                <div class="info-box">
                    <div class="info-row">
                        <span>Frequency:</span>
                        <span class="value" id="freqDisplay">12 GHz</span>
                    </div>
                    <div style="margin-top: 8px;">
                        <label style="font-size: 11px; color: #aaa;">Frequency (GHz):</label>
                        <input type="range" id="freqSlider" min="10" max="20" value="12" style="margin-top: 4px;">
                    </div>
                    <div class="info-row" style="margin-top: 8px;">
                        <span>Beamwidth:</span>
                        <span class="value" id="beamwidthDisplay">~3.0¬∞</span>
                    </div>
                    <div class="info-row">
                        <span>Beam @ 20m:</span>
                        <span class="value" id="beam20Display">~1.0m wide</span>
                    </div>
                    <div class="info-row">
                        <span>Beam @ 30m:</span>
                        <span class="value" id="beam30Display">~1.6m wide</span>
                    </div>
                </div>
                <div class="highlight-note">
                    <strong>‚ö†Ô∏è Critical Insight:</strong><br>
                    The RF beam is MUCH narrower than the FOV cone in the first 50m. Trees at 20-30m are in a tight beam path.
                </div>
            </div>

            <div class="section">
                <h3>üìê Installation Type</h3>
                <div class="btn-group">
                    <button class="btn" id="groundBtn">Ground/Pole<br>1.7m / 5.6ft</button>
                    <button class="btn active" id="roofBtn">Roof Mount<br>5.0m / 16.4ft</button>
                </div>
            </div>

            <div class="section">
                <h3>üìè Installation Height</h3>
                <div class="slider-label">
                    <span>Height from ground</span>
                    <span class="value" id="heightValue">5.0m / 16.4ft</span>
                </div>
                <input type="range" id="heightSlider" min="1" max="10" step="0.1" value="5">
            </div>

            <div class="section">
                <h3>üéØ FOV Cone Angle</h3>
                <div class="slider-label">
                    <span>Cone angle</span>
                    <span class="value" id="fovValue">110 deg</span>
                </div>
                <input type="range" id="fovSlider" min="90" max="120" value="110">
            </div>

            <div class="section">
                <h3>üß≠ Cone Direction (Azimuth)</h3>
                <div class="slider-label">
                    <span>Rotation</span>
                    <span class="value" id="rotationValue">0¬∞ (North)</span>
                </div>
                <input type="range" id="rotationSlider" min="0" max="360" value="0">
                <div class="note">Antenna is azimuth independent - can face any direction</div>
            </div>

            <div id="questionBox" style="display: none;" class="question-box">
                <h4>üìã Site Assessment Questions</h4>
                
                <div class="question-item">
                    <label>Are there tall trees (40ft+) WITHIN the cone?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="trees" value="no"> No</label>
                        <label><input type="radio" name="trees" value="yes"> Yes</label>
                    </div>
                </div>

                <div class="question-item">
                    <label>If trees present, are they close (<30m) OR very tall?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="buildings" value="no"> Distant/short</label>
                        <label><input type="radio" name="buildings" value="yes"> Close/tall</label>
                    </div>
                </div>

                <div class="question-item">
                    <label>Overall sky view in direction (check Street View)?</label>
                    <div class="radio-group">
                        <label><input type="radio" name="clear" value="yes"> Clear</label>
                        <label><input type="radio" name="clear" value="no"> Obstructed</label>
                    </div>
                </div>

                <button class="assess-btn" id="assessBtn">Generate Assessment</button>
            </div>

            <div id="assessmentBox" style="display: none;"></div>

            <div class="section">
                <h3>üìä Coverage Info</h3>
                <div class="info-box">
                    <div class="info-row">
                        <span>Direction:</span>
                        <span class="value" id="directionDisplay">NORTH (0¬∞)</span>
                    </div>
                    <div class="info-row">
                        <span>Ground Range:</span>
                        <span class="value" id="rangeValue">3.5m / 11.5ft</span>
                    </div>
                    <div class="info-row">
                        <span>Coverage Area:</span>
                        <span class="value" id="areaValue">10.7 sq m / 115.2 sq ft</span>
                    </div>
                </div>
            </div>

            <div class="section" id="locationBox" style="display: none;">
                <h3>üìç Installation Location</h3>
                <div class="info-box">
                    <div class="info-row">
                        <span>Latitude:</span>
                        <span class="value" id="latValue">--</span>
                    </div>
                    <div class="info-row">
                        <span>Longitude:</span>
                        <span class="value" id="lngValue">--</span>
                    </div>
                    <div id="dmsRow" style="display: none; margin-top: 8px; padding-top: 8px; border-top: 1px solid #444;">
                        <div style="font-size: 11px; color: #888; margin-bottom: 4px;">DMS Format:</div>
                        <div id="dmsValue" style="font-size: 11px; color: #00ff00;"></div>
                    </div>
                    <button class="btn" id="toggleDmsBtn" style="margin-top: 8px; width: 100%;">Show DMS Format</button>
                </div>
            </div>

            <div class="section">
                <div class="note">
                    <strong>üå≤ Tree Clearance Guide</strong><br>
                    Critical Zone: Within 30m of installation<br>
                    Tall trees (40ft+) within 30m may block signal if taller than roof height.<br><br>
                    <strong>NEW: RF Beam Path</strong><br>
                    The actual RF beam is only ~50-80cm wide at 20-30m.
                </div>
            </div>

            <div class="section" style="border: 2px solid #ffa500;">
                <h3 style="color: #ffa500;">‚ö†Ô∏è Tool Limitations</h3>
                <div style="font-size: 11px; line-height: 1.6;">
                    <strong style="color: #00ff00;">ACCURATE FOR:</strong><br>
                    ‚úÖ Obvious rejections (dense forest, blocked sky)<br>
                    ‚úÖ Obvious approvals (clear fields, parking lots)<br>
                    ‚úÖ North direction indicator<br>
                    ‚úÖ Lat/long coordinates<br><br>
                    
                    <strong style="color: #ffa500;">LIMITED ACCURACY:</strong><br>
                    ‚ö†Ô∏è Tree distance beyond 30m (perspective distortion)<br>
                    ‚ö†Ô∏è Tree heights (2D imagery only)<br>
                    ‚ö†Ô∏è Imagery may be 1-5 years old<br>
                    ‚ö†Ô∏è Marginal sites need validation<br><br>
                    
                    <strong style="color: #ff4444;">NOT A REPLACEMENT FOR:</strong><br>
                    ‚ùå On-site surveys<br>
                    ‚ùå Professional RF site tools<br>
                    ‚ùå Final decisions on borderline sites<br><br>
                    
                    <strong>USE THIS TOOL TO:</strong> Filter obvious sites, then validate marginal cases with Street View, customer photos, or on-site survey.
                </div>
            </div>

            <button class="clear-btn" id="clearBtn" style="display: none;">Clear Placement</button>
        </div>
    </div>

    <script>
        var MARKER_SIZE = 18;
        var DISH_DIAMETER_M = 0.48;
        var BEAM_FREQUENCY_GHZ = 12;
        var SPEED_OF_LIGHT = 299792458;
        var BEAM_MAX_RANGE_M = 100;
        var showBeamDivergence = false;
        
        var map;
        var panorama;
        var streetViewService;
        var isStreetView = false;
        var marker;
        var cone;
        var beamCone;
        var searchMarker;
        var directionLine;
        var installHeight = 5.0;
        var fovAngle = 110;
        var coneOpacity = 0.25;
        var showDms = false;
        var coneRotation = 0;
        
        var measureMode = false;
        var measureStart = null;
        var measureMarkers = [];
        
        var distanceCircles = [];
        var showDistanceCircles = false;

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 47.5301, lng: -122.0326 },
                zoom: 20,
                mapTypeId: 'satellite',
                tilt: 0,
                streetViewControl: true
            });
            
            panorama = map.getStreetView();
            streetViewService = new google.maps.StreetViewService();

            map.addListener('click', function(e) {
                if (measureMode) {
                    handleMeasureClick(e.latLng);
                } else {
                    placeMarker(e.latLng);
                }
            });

            updateCalculations();
            updateBeamCalculations();
        }

        function placeMarker(location) {
            if (marker) marker.setMap(null);
            if (cone) cone.setMap(null);
            if (beamCone) beamCone.setMap(null);
            if (directionLine) directionLine.setMap(null);

            marker = new google.maps.Marker({
                position: location,
                map: map,
                draggable: true,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: MARKER_SIZE,
                    fillColor: '#ff0000',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 3
                }
            });

            marker.addListener('drag', function() {
                updateCone();
                updateLocationDisplay();
            });
            
            marker.addListener('dragend', function() {
                updateCone();
                updateLocationDisplay();
            });
            
            updateCone();
            updateLocationDisplay();
            document.getElementById('clearBtn').style.display = 'block';
            document.getElementById('questionBox').style.display = 'block';
            document.getElementById('locationBox').style.display = 'block';
            document.getElementById('assessmentBox').style.display = 'none';
            
            document.querySelectorAll('input[type="radio"]').forEach(function(radio) {
                radio.checked = false;
            });
        }

        function updateLocationDisplay() {
            if (marker) {
                var pos = marker.getPosition();
                var lat = pos.lat();
                var lng = pos.lng();
                
                document.getElementById('latValue').textContent = lat.toFixed(6);
                document.getElementById('lngValue').textContent = lng.toFixed(6);
                
                var latDMS = convertToDMS(lat, true);
                var lngDMS = convertToDMS(lng, false);
                document.getElementById('dmsValue').textContent = latDMS + ' ' + lngDMS;
            }
        }
        
        function convertToDMS(decimal, isLat) {
            var absolute = Math.abs(decimal);
            var degrees = Math.floor(absolute);
            var minutesDecimal = (absolute - degrees) * 60;
            var minutes = Math.floor(minutesDecimal);
            var seconds = Math.floor((minutesDecimal - minutes) * 60);
            
            var direction;
            if (isLat) {
                direction = decimal >= 0 ? 'N' : 'S';
            } else {
                direction = decimal >= 0 ? 'E' : 'W';
            }
            
            return degrees + '¬∞' + minutes + "'" + seconds + '"' + direction;
        }

        function calculateBeamwidth() {
            var wavelength = SPEED_OF_LIGHT / (BEAM_FREQUENCY_GHZ * 1e9);
            var beamwidthRad = wavelength / DISH_DIAMETER_M;
            var beamwidthDeg = beamwidthRad * (180 / Math.PI);
            return beamwidthDeg;
        }

        function updateBeamCalculations() {
            var beamwidth = calculateBeamwidth();
            document.getElementById('beamwidthDisplay').textContent = '~' + beamwidth.toFixed(1) + '¬∞';
            
            var beamwidthRad = beamwidth * (Math.PI / 180);
            var radius20m = 20 * Math.tan(beamwidthRad / 2);
            var radius30m = 30 * Math.tan(beamwidthRad / 2);
            
            document.getElementById('beam20Display').textContent = '~' + (radius20m * 2).toFixed(1) + 'm wide';
            document.getElementById('beam30Display').textContent = '~' + (radius30m * 2).toFixed(1) + 'm wide';
            document.getElementById('freqDisplay').textContent = BEAM_FREQUENCY_GHZ + ' GHz';
        }

        function updateCone() {
            if (!marker) return;
            
            if (cone) cone.setMap(null);
            if (beamCone) beamCone.setMap(null);
            if (directionLine) directionLine.setMap(null);

            var elevationAngle = 35 * Math.PI / 180;
            var maxGroundDistance = installHeight / Math.tan(elevationAngle);
            var center = marker.getPosition();
            
            // Main FOV cone
            var path = [];
            path.push(center);
            var halfAngle = fovAngle / 2;
            
            for (var i = 0; i <= 30; i++) {
                var angle = (coneRotation - halfAngle + (fovAngle * i / 30)) * Math.PI / 180;
                var lat = center.lat() + (maxGroundDistance / 111320) * Math.cos(angle);
                var lng = center.lng() + (maxGroundDistance / (111320 * Math.cos(center.lat() * Math.PI / 180))) * Math.sin(angle);
                path.push(new google.maps.LatLng(lat, lng));
            }
            path.push(center);

            cone = new google.maps.Polygon({
                paths: path,
                strokeColor: '#00ff00',
                strokeWeight: 3,
                fillColor: '#00ff00',
                fillOpacity: coneOpacity,
                map: map
            });
            
            // Beam cone if enabled
            if (showBeamDivergence) {
                var beamwidth = calculateBeamwidth();
                var beamHalfAngle = beamwidth / 2;
                var beamMaxDistance = Math.min(BEAM_MAX_RANGE_M, maxGroundDistance);
                
                var beamPath = [];
                beamPath.push(center);
                
                for (var i = 0; i <= 30; i++) {
                    var angle = (coneRotation - beamHalfAngle + (beamwidth * i / 30)) * Math.PI / 180;
                    var lat = center.lat() + (beamMaxDistance / 111320) * Math.cos(angle);
                    var lng = center.lng() + (beamMaxDistance / (111320 * Math.cos(center.lat() * Math.PI / 180))) * Math.sin(angle);
                    beamPath.push(new google.maps.LatLng(lat, lng));
                }
                beamPath.push(center);
                
                beamCone = new google.maps.Polygon({
                    paths: beamPath,
                    strokeColor: '#ff6600',
                    strokeWeight: 4,
                    fillColor: '#ff6600',
                    fillOpacity: 0.35,
                    map: map,
                    zIndex: 1000
                });
            }
            
            // Direction line
            var lineLength = maxGroundDistance * 1.2;
            var lineAngle = coneRotation * Math.PI / 180;
            var lineEndLat = center.lat() + (lineLength / 111320) * Math.cos(lineAngle);
            var lineEndLng = center.lng() + (lineLength / (111320 * Math.cos(center.lat() * Math.PI / 180))) * Math.sin(lineAngle);
            
            directionLine = new google.maps.Polyline({
                path: [center, new google.maps.LatLng(lineEndLat, lineEndLng)],
                strokeColor: '#ff0000',
                strokeWeight: 6,
                strokeOpacity: 1.0,
                map: map,
                zIndex: 10000
            });
            
            var directionName = getDirectionName(coneRotation);
            document.getElementById('directionDisplay').textContent = directionName + ' (' + coneRotation + '¬∞)';
        }
        
        function getDirectionName(degrees) {
            if (degrees >= 337.5 || degrees < 22.5) return 'NORTH';
            if (degrees >= 22.5 && degrees < 67.5) return 'NE';
            if (degrees >= 67.5 && degrees < 112.5) return 'EAST';
            if (degrees >= 112.5 && degrees < 157.5) return 'SE';
            if (degrees >= 157.5 && degrees < 202.5) return 'SOUTH';
            if (degrees >= 202.5 && degrees < 247.5) return 'SW';
            if (degrees >= 247.5 && degrees < 292.5) return 'WEST';
            if (degrees >= 292.5 && degrees < 337.5) return 'NW';
            return 'NORTH';
        }

        function performAssessment() {
            var trees = document.querySelector('input[name="trees"]:checked');
            var buildings = document.querySelector('input[name="buildings"]:checked');
            var clear = document.querySelector('input[name="clear"]:checked');
            
            if (!trees || !buildings || !clear) {
                alert('Please answer all questions before generating assessment');
                return;
            }
            
            var box = document.getElementById('assessmentBox');
            box.style.display = 'block';
            
            var score = 0;
            var issues = [];
            
            if (installHeight >= 4.5) {
                score += 3;
            } else if (installHeight >= 2.5) {
                score += 2;
                issues.push('Marginal installation height (' + installHeight.toFixed(1) + 'm)');
            } else {
                score += 0;
                issues.push('Installation height too low (' + installHeight.toFixed(1) + 'm)');
            }
            
            if (trees.value === 'no') {
                score += 3;
            } else {
                score += 0;
                issues.push('Trees present in FOV - may block signal');
            }
            
            if (buildings.value === 'no') {
                score += 2;
            } else {
                score += 0;
                issues.push('Close/tall trees present - likely obstruction');
            }
            
            if (clear.value === 'yes') {
                score += 2;
            } else {
                score += 0;
                issues.push('Coverage area obstructed');
            }
            
            var html = '';
            
            if ((trees.value === 'yes' || buildings.value === 'yes') && score < 8) {
                html = '<div class="assessment warning">';
                html += '<div style="font-size:20px; margin-bottom:10px">‚ö† MARGINAL SITE</div>';
                html += '<div style="font-size:11px; color:#ffa500; margin-bottom:10px">CONFIDENCE: MEDIUM - Requires validation</div>';
                html += '<div style="margin-bottom:10px">Issues detected:</div>';
                html += '<ul style="text-align:left; margin:0; padding-left:20px; font-size:12px;">';
                issues.forEach(function(issue) {
                    html += '<li>' + issue + '</li>';
                });
                html += '</ul>';
                html += '<div style="margin-top:10px; font-size:12px">Score: ' + score + '/10</div>';
                html += '<div style="margin-top:10px; font-size:11px; font-weight:bold;">üí° Recommend: Customer photos, Street View check, or on-site survey</div>';
                html += '</div>';
            } else if (score >= 8 && issues.length === 0) {
                html = '<div class="assessment good">';
                html += '<div style="font-size:20px; margin-bottom:8px">‚úì EXCELLENT SITE</div>';
                html += '<div style="font-size:11px; color:#00ff00; margin-bottom:8px">CONFIDENCE: HIGH - Screening suggests approval</div>';
                html += '<div>Installation likely to succeed</div>';
                html += '<div style="margin-top:8px; font-size:12px">Score: ' + score + '/10</div>';
                html += '<div style="margin-top:8px; font-size:10px; font-style:italic;">Note: Final approval may still require on-site validation</div>';
                html += '</div>';
            } else if (score >= 5) {
                html = '<div class="assessment warning">';
                html += '<div style="font-size:20px; margin-bottom:8px">‚ö† MARGINAL SITE</div>';
                html += '<div style="font-size:11px; color:#ffa500; margin-bottom:8px">CONFIDENCE: MEDIUM - Requires validation</div>';
                html += '<div style="margin-bottom:8px">Issues detected:</div>';
                html += '<ul style="text-align:left; margin:0; padding-left:20px; font-size:12px;">';
                issues.forEach(function(issue) {
                    html += '<li>' + issue + '</li>';
                });
                html += '</ul>';
                html += '<div style="margin-top:8px; font-size:12px">Score: ' + score + '/10</div>';
                html += '<div style="margin-top:8px; font-size:11px">Recommend: Request customer photos or on-site survey</div>';
                html += '</div>';
            } else {
                html = '<div class="assessment bad">';
                html += '<div style="font-size:20px; margin-bottom:8px">‚úó POOR SITE</div>';
                html += '<div style="font-size:11px; color:#ff4444; margin-bottom:8px">CONFIDENCE: HIGH - Screening suggests rejection</div>';
                html += '<div style="margin-bottom:8px">Major issues:</div>';
                html += '<ul style="text-align:left; margin:0; padding-left:20px; font-size:12px;">';
                issues.forEach(function(issue) {
                    html += '<li>' + issue + '</li>';
                });
                html += '</ul>';
                html += '<div style="margin-top:8px; font-size:12px">Score: ' + score + '/10</div>';
                html += '<div style="margin-top:8px; font-size:11px">Recommend alternative location or configuration</div>';
                html += '</div>';
            }
            
            box.innerHTML = html;
        }

        function updateCalculations() {
            var elevationAngle = 35 * Math.PI / 180;
            var maxGroundDistance = installHeight / Math.tan(elevationAngle);
            var maxGroundDistanceFt = maxGroundDistance * 3.28084;
            
            var area = (Math.PI * maxGroundDistance * maxGroundDistance * fovAngle) / 360;
            var areaSqFt = area * 10.7639;
            
            document.getElementById('rangeValue').textContent = maxGroundDistance.toFixed(1) + 'm / ' + maxGroundDistanceFt.toFixed(1) + 'ft';
            document.getElementById('areaValue').textContent = area.toFixed(1) + ' sq m / ' + areaSqFt.toFixed(1) + ' sq ft';
        }

        function handleMeasureClick(location) {
            if (!measureStart) {
                measureStart = location;
                var startMarker = new google.maps.Marker({
                    position: location,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 6,
                        fillColor: '#ffff00',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    }
                });
                measureMarkers.push(startMarker);
            } else {
                var distance = google.maps.geometry.spherical.computeDistanceBetween(measureStart, location);
                var distanceFt = distance * 3.28084;
                
                var endMarker = new google.maps.Marker({
                    position: location,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 6,
                        fillColor: '#ffff00',
                        fillOpacity: 1,
                        strokeColor: '#ffffff',
                        strokeWeight: 2
                    }
                });
                measureMarkers.push(endMarker);
                
                var line = new google.maps.Polyline({
                    path: [measureStart, location],
                    strokeColor: '#ffff00',
                    strokeWeight: 3,
                    map: map
                });
                measureMarkers.push(line);
                
                var midLat = (measureStart.lat() + location.lat()) / 2;
                var midLng = (measureStart.lng() + location.lng()) / 2;
                
                var label = new google.maps.Marker({
                    position: {lat: midLat, lng: midLng},
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 0
                    },
                    label: {
                        text: distance.toFixed(1) + 'm / ' + distanceFt.toFixed(1) + 'ft',
                        color: '#00ff00',
                        fontSize: '14px',
                        fontWeight: 'bold'
                    }
                });
                measureMarkers.push(label);
                
                measureStart = null;
                measureMode = false;
                document.getElementById('measureBtn').classList.remove('active');
            }
        }

        function toggleDistanceCircles() {
            if (!marker) {
                alert('Place a marker first to show critical zone');
                return;
            }
            
            if (showDistanceCircles) {
                distanceCircles.forEach(function(circle) {
                    circle.setMap(null);
                });
                distanceCircles = [];
                showDistanceCircles = false;
                document.getElementById('distanceCirclesBtn').classList.remove('active');
            } else {
                var center = marker.getPosition();
                
                var circle = new google.maps.Circle({
                    center: center,
                    radius: 30,
                    strokeColor: '#ff4444',
                    strokeOpacity: 0.8,
                    strokeWeight: 3,
                    fillColor: '#ff4444',
                    fillOpacity: 0.1,
                    map: map
                });
                distanceCircles.push(circle);
                
                var labelPos = google.maps.geometry.spherical.computeOffset(center, 30, 45);
                var label = new google.maps.Marker({
                    position: labelPos,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 0
                    },
                    label: {
                        text: 'Critical Zone (30m)',
                        color: '#ff4444',
                        fontSize: '12px',
                        fontWeight: 'bold'
                    }
                });
                distanceCircles.push(label);
                
                showDistanceCircles = true;
                document.getElementById('distanceCirclesBtn').classList.add('active');
            }
        }

        // EVENT LISTENERS
        document.getElementById('toggleBeamBtn').addEventListener('click', function() {
            showBeamDivergence = !showBeamDivergence;
            this.classList.toggle('active');
            this.textContent = showBeamDivergence ? 'Hide Beam Path' : 'Show Beam Path';
            updateCone();
        });

        document.getElementById('freqSlider').addEventListener('input', function() {
            BEAM_FREQUENCY_GHZ = parseInt(this.value);
            updateBeamCalculations();
            if (showBeamDivergence) {
                updateCone();
            }
        });

        document.getElementById('distanceCirclesBtn').addEventListener('click', toggleDistanceCircles);

        document.getElementById('toggleViewBtn').addEventListener('click', function() {
            if (!marker) {
                alert('Please place a marker first');
                return;
            }
            
            var markerPos = marker.getPosition();
            
            if (!isStreetView) {
                streetViewService.getPanorama({
                    location: markerPos,
                    radius: 50
                }, function(data, status) {
                    if (status === 'OK') {
                        panorama.setPosition(data.location.latLng);
                        panorama.setPov({
                            heading: coneRotation,
                            pitch: 35
                        });
                        panorama.setVisible(true);
                        isStreetView = true;
                        document.getElementById('toggleViewBtn').textContent = 'üó∫Ô∏è Satellite';
                        document.getElementById('toggleViewBtn').classList.add('active');
                    } else {
                        alert('Street View not available at this location');
                    }
                });
            } else {
                panorama.setVisible(false);
                isStreetView = false;
                document.getElementById('toggleViewBtn').textContent = 'üëÅÔ∏è Street View';
                document.getElementById('toggleViewBtn').classList.remove('active');
            }
        });

        document.getElementById('measureBtn').addEventListener('click', function() {
            measureMode = !measureMode;
            this.classList.toggle('active');
            if (measureMode) {
                measureStart = null;
            }
        });

        document.getElementById('clearToolsBtn').addEventListener('click', function() {
            measureMarkers.forEach(function(item) {
                item.setMap(null);
            });
            measureMarkers = [];
            measureStart = null;
            measureMode = false;
            document.getElementById('measureBtn').classList.remove('active');
        });

        document.getElementById('opacitySlider').addEventListener('input', function() {
            coneOpacity = parseInt(this.value) / 100;
            document.getElementById('opacityValue').textContent = this.value + '%';
            if (cone) {
                cone.setOptions({fillOpacity: coneOpacity});
            }
        });

        document.getElementById('assessBtn').addEventListener('click', performAssessment);

        document.getElementById('searchBtn').addEventListener('click', function() {
            var address = document.getElementById('addressInput').value;
            if (!address) {
                alert('Please enter an address');
                return;
            }
            var geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: address }, function(results, status) {
                if (status === 'OK') {
                    map.setCenter(results[0].geometry.location);
                    map.setZoom(21);
                    
                    if (searchMarker) {
                        searchMarker.setMap(null);
                    }
                    
                    searchMarker = new google.maps.Marker({
                        position: results[0].geometry.location,
                        map: map,
                        animation: google.maps.Animation.BOUNCE,
                        icon: {
                            path: google.maps.SymbolPath.BACKWARD_CLOSED_ARROW,
                            scale: 8,
                            fillColor: '#00ff00',
                            fillOpacity: 1,
                            strokeColor: '#ffffff',
                            strokeWeight: 3,
                            rotation: 180
                        },
                        label: {
                            text: 'üìç',
                            color: '#00ff00',
                            fontSize: '20px'
                        }
                    });
                    
                    setTimeout(function() {
                        if (searchMarker) {
                            searchMarker.setAnimation(null);
                        }
                    }, 3000);
                } else {
                    alert('Address not found: ' + status);
                }
            });
        });

        document.getElementById('addressInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('searchBtn').click();
            }
        });

        document.getElementById('groundBtn').addEventListener('click', function() {
            installHeight = 1.7;
            document.getElementById('groundBtn').classList.add('active');
            document.getElementById('roofBtn').classList.remove('active');
            document.getElementById('heightSlider').value = 1.7;
            document.getElementById('heightValue').textContent = '1.7m / 5.6ft';
            updateCalculations();
            updateCone();
        });

        document.getElementById('roofBtn').addEventListener('click', function() {
            installHeight = 5.0;
            document.getElementById('roofBtn').classList.add('active');
            document.getElementById('groundBtn').classList.remove('active');
            document.getElementById('heightSlider').value = 5.0;
            document.getElementById('heightValue').textContent = '5.0m / 16.4ft';
            updateCalculations();
            updateCone();
        });

        document.getElementById('heightSlider').addEventListener('input', function() {
            installHeight = parseFloat(this.value);
            var heightFt = installHeight * 3.28084;
            document.getElementById('heightValue').textContent = installHeight.toFixed(1) + 'm / ' + heightFt.toFixed(1) + 'ft';
            updateCalculations();
            updateCone();
        });

        document.getElementById('fovSlider').addEventListener('input', function() {
            fovAngle = parseInt(this.value);
            document.getElementById('fovValue').textContent = fovAngle + ' deg';
            updateCalculations();
            updateCone();
        });
        
        document.getElementById('rotationSlider').addEventListener('input', function() {
            coneRotation = parseInt(this.value);
            var dirName = getDirectionName(coneRotation);
            document.getElementById('rotationValue').textContent = coneRotation + '¬∞ (' + dirName + ')';
            updateCone();
        });

        document.getElementById('clearBtn').addEventListener('click', function() {
            if (marker) marker.setMap(null);
            if (cone) cone.setMap(null);
            if (beamCone) beamCone.setMap(null);
            if (directionLine) directionLine.setMap(null);
            
            marker = null;
            cone = null;
            beamCone = null;
            directionLine = null;
            
            document.getElementById('assessmentBox').style.display = 'none';
            document.getElementById('questionBox').style.display = 'none';
            document.getElementById('locationBox').style.display = 'none';
            this.style.display = 'none';
        });
        
        document.getElementById('toggleDmsBtn').addEventListener('click', function() {
            showDms = !showDms;
            if (showDms) {
                document.getElementById('dmsRow').style.display = 'block';
                this.textContent = 'Hide DMS Format';
            } else {
                document.getElementById('dmsRow').style.display = 'none';
                this.textContent = 'Show DMS Format';
            }
        });
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCo3bz9Sam8ZcLlLsUaMajGR1RJ5Kw62C4&callback=initMap&libraries=geometry" async defer></script>
</body>
</html>